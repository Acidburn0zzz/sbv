-----------------------------------------------------------------------------
-- |
-- Module      :  Data.SBV.SMT.SMTLib2
-- Copyright   :  (c) Levent Erkok
-- License     :  BSD3
-- Maintainer  :  erkokl@gmail.com
-- Stability   :  experimental
-- Portability :  portable
--
-- Conversion of symbolic programs to SMTLib format, Using v2 of the standard
-----------------------------------------------------------------------------
{-# LANGUAGE PatternGuards #-}

module Data.SBV.SMT.SMTLib2(cvt, addNonEqConstraints) where

import Data.List (intercalate)

import Data.SBV.BitVectors.Data

addNonEqConstraints :: [[(String, CW)]] -> SMTLibPgm -> String
addNonEqConstraints nonEqConstraints (SMTLibPgm _ (aliasTable, pre, post)) = intercalate "\n" $
     pre
  ++ [ "; --- refuted-models ---" ]
  ++ concatMap nonEqs (map (map intName) nonEqConstraints)
  ++ post
 where intName (s, c)
          | Just sw <- s `lookup` aliasTable = (show sw, c)
          | True                             = (s, c)

-- We do not need this currently since we do not yet support allSat for SMT-Lib2
-- targets. But eventually we'll have to implement this as we settle on SMT-Lib2 for
-- all interaction.
nonEqs :: [(String, CW)] -> [String]
nonEqs _ =  error "SBV: TBD: SMTLib2: Support for non-eq-constraints not implemented yet."

cvt :: Bool                                        -- ^ is this a sat problem?
    -> [String]                                    -- ^ extra comments to place on top
    -> [(Quantifier, NamedSymVar)]                 -- ^ inputs and aliasing names
    -> [(SW, CW)]                                  -- ^ constants
    -> [((Int, (Bool, Int), (Bool, Int)), [SW])]   -- ^ auto-generated tables
    -> [(Int, ArrayInfo)]                          -- ^ user specified arrays
    -> [(String, SBVType)]                         -- ^ uninterpreted functions/constants
    -> [(String, [String])]                        -- ^ user given axioms
    -> Pgm                                         -- ^ assignments
    -> SW                                          -- ^ output variable
    -> ([String], [String])
cvt _isSat comments qinps _consts _tbls _arrs _uis _axs _asgnsSeq _out
  | not (needsExistentials (map fst qinps))
  = error "SBV: Existential variables are not supported via SMT-Lib. Use the QBVF solver instead."
  | True
  = (pre, post ++ ["(check-sat)", "(get-value (s0))"])
  where pre  = [ "; Automatically generated by SBV. Do not edit."
               , "(set-option :produce-models true)"
               ] ++ map ("; " ++) comments
        post = [ "(declare-fun s0 () (_ BitVec 16))"
               , "(assert (forall ((s1 (_ BitVec 16))) (bvuge s1 s0)))"
               ]
